<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Valkey Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .chart-container {
      width: 100%;
      max-width: 1200px;
      margin-bottom: 50px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #f2f2f2;
    }
  </style>
</head>

<body>
  <h1>Valkey Dashboard</h1>
  <div class="chart-container">
    <canvas id="prCreationChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="weeklyOpenChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="stalenessChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="firstInteractionChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="responseChart"></canvas>
  </div>
  <h2>Top Stale PRs</h2>
  <table id="topStalePRs">
    <thead>
      <tr>
        <th>PR</th>
        <th>Title</th>
        <th>Author</th>
        <th>Reviewers</th>
        <th>Created</th>
        <th>Last Event</th>
        <th>Stale Hours</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function fetchMetrics() {
      const res = await fetch('metrics.json');
      const data = await res.json();
      return data;
    }

    function plotWeeklyChart(ctx, labels, datasets, title) {
      new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: title },
            legend: { display: true }
          },
          scales: {
            x: { display: true, title: { display: true, text: 'Week' } },
            y: { display: true }
          }
        }
      });
    }

    function populateTopStaleTable(prs) {
      const tbody = document.querySelector('#topStalePRs tbody');
      prs.forEach(pr => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a href="${pr.url}" target="_blank">#${pr.number}</a></td>
          <td>${pr.title}</td>
          <td>${pr.author || ''}</td>
          <td>${pr.reviewers.join(', ')}</td>
          <td>${pr.created_at}</td>
          <td>${pr.last_event_at}</td>
          <td>${pr.stale_hours.toFixed(1)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function prepareLabelsAndData(weeklyDict) {
      const entries = Object.entries(weeklyDict).sort((a, b) => new Date(a[0]) - new Date(b[0]));
      const labels = entries.map(e => e[0]);
      const values = entries.map(e => e[1]);
      return { labels, values };
    }

    (async () => {
      const metrics = await fetchMetrics();

      // PR Creation
      const creation = prepareLabelsAndData(metrics.pr_creation_weekly);
      const closed = prepareLabelsAndData(metrics.pr_close_weekly);
      const delta = creation.values.map((val, i) => val - (closed.values[i] || 0));

      plotWeeklyChart(
        document.getElementById('prCreationChart').getContext('2d'),
        creation.labels,
        [{ label: 'PRs Created', data: creation.values, borderColor: 'rgba(54, 162, 235, 0.2)', backgroundColor: 'rgba(54, 162, 235, 0.1)', fill: false, borderWidth: 2, ointRadius: 3 },
        { label: 'PRs Closed', data: closed.values, borderColor: 'rgba(34, 197, 94, 0.2)', backgroundColor: 'rgba(34, 197, 94, 0.1)', fill: false, borderWidth: 2, ointRadius: 3 },
        { label: 'PRs Delta', data: delta, borderColor: 'orange', fill: false }
        ],
        'PR Creation per Week'
      );

      const weeklyOpenData = metrics.weekly_open_prs || {};
      const openLabels = Object.keys(weeklyOpenData).sort();
      const openValues = openLabels.map(week => weeklyOpenData[week]);

      new Chart(document.getElementById('weeklyOpenChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: openLabels,
          datasets: [
            {
              label: 'Total Open PRs',
              data: openValues,
              borderColor: 'rgba(0, 128, 0, 0.5)',
              backgroundColor: 'rgba(0, 128, 0, 0.2)',
              borderWidth: 2,
              fill: false,
              pointRadius: 3
            }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } } }
      });

      // Staleness P50, P90, P100
      const staleLabels = Object.keys(metrics.stale_weekly_metrics).sort();
      const p50 = staleLabels.map(w => metrics.stale_weekly_metrics[w].p50);
      const p90 = staleLabels.map(w => metrics.stale_weekly_metrics[w].p90);
      const p100 = staleLabels.map(w => metrics.stale_weekly_metrics[w].p100);

      plotWeeklyChart(
        document.getElementById('stalenessChart').getContext('2d'),
        staleLabels,
        [
          { label: 'P50', data: p50, borderColor: 'green', fill: false },
          { label: 'P90', data: p90, borderColor: 'red', fill: false },
          { label: 'P100', data: p100, borderColor: 'black', fill: false }
        ],
        'PR Staleness (hours) per Week'
      );

      const firstInteractionWeekly = metrics.first_interaction_weekly_metrics || {};
      const firstWeeks = Object.keys(firstInteractionWeekly).sort();
      const p50Values = firstWeeks.map(week => firstInteractionWeekly[week].p50);
      const p90Values = firstWeeks.map(week => firstInteractionWeekly[week].p90);
      const p100Values = firstWeeks.map(week => firstInteractionWeekly[week].p100);

      new Chart(document.getElementById('firstInteractionChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: firstWeeks,
          datasets: [
            { label: 'P50 (hours)', data: p50Values, borderColor: 'blue', fill: false },
            { label: 'P90 (hours)', data: p90Values, borderColor: 'orange', fill: false },
            { label: 'P100 (hours)', data: p100Values, borderColor: 'red', fill: false }
          ]
        },
        options: {
          responsive: true, plugins: {
            legend: { position: 'top' },
            title: {
              display: true,       // show the title
              text: 'PR First Interaction Time (Weekly)', // your title
              font: { size: 18 },  // optional: font size
              padding: { top: 10, bottom: 20 }
            }
          }
        }
      });

      // Response time P50, P90, P100
      const respLabels = Object.keys(metrics.response_weekly_metrics).sort();
      const r50 = respLabels.map(w => metrics.response_weekly_metrics[w].p50);
      const r99 = respLabels.map(w => metrics.response_weekly_metrics[w].p90);
      const r100 = respLabels.map(w => metrics.response_weekly_metrics[w].p100);

      plotWeeklyChart(
        document.getElementById('responseChart').getContext('2d'),
        respLabels,
        [
          { label: 'P50', data: r50, borderColor: 'green', fill: false },
          { label: 'P90', data: r99, borderColor: 'red', fill: false },
          { label: 'P100', data: r100, borderColor: 'black', fill: false }
        ],
        'PR Response Time (hours) per Week'
      );

      // Top Stale PRs
      populateTopStaleTable(metrics.top_stale_prs);
    })();
  </script>
</body>

</html>
