<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Valkey Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .chart-container {
      width: 100%;
      max-width: 1200px;
      margin-bottom: 50px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #f2f2f2;
    }
  </style>
</head>

<body>
  <h1>Valkey Dashboard</h1>
  <div class="chart-container">
    <canvas id="prCreationChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="prClosedChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="stalenessChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="responseChart"></canvas>
  </div>
  <h2>Top Stale PRs</h2>
  <table id="topStalePRs">
    <thead>
      <tr>
        <th>PR</th>
        <th>Title</th>
        <th>Author</th>
        <th>Reviewers</th>
        <th>Created</th>
        <th>Last Event</th>
        <th>Stale Hours</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function fetchMetrics() {
      const res = await fetch('metrics.json');
      const data = await res.json();
      return data;
    }

    function plotWeeklyChart(ctx, labels, datasets, title) {
      new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: title },
            legend: { display: true }
          },
          scales: {
            x: { display: true, title: { display: true, text: 'Week' } },
            y: { display: true }
          }
        }
      });
    }

    function populateTopStaleTable(prs) {
      const tbody = document.querySelector('#topStalePRs tbody');
      prs.forEach(pr => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a href="${pr.url}" target="_blank">#${pr.number}</a></td>
          <td>${pr.title}</td>
          <td>${pr.author || ''}</td>
          <td>${pr.reviewers.join(', ')}</td>
          <td>${pr.created_at}</td>
          <td>${pr.last_event_at}</td>
          <td>${pr.stale_hours.toFixed(1)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function prepareLabelsAndData(weeklyDict) {
      const entries = Object.entries(weeklyDict).sort((a, b) => new Date(a[0]) - new Date(b[0]));
      const labels = entries.map(e => e[0]);
      const values = entries.map(e => e[1]);
      return { labels, values };
    }

    (async () => {
      const metrics = await fetchMetrics();

      // PR Creation
      const creation = prepareLabelsAndData(metrics.pr_creation_weekly);
      plotWeeklyChart(
        document.getElementById('prCreationChart').getContext('2d'),
        creation.labels,
        [{ label: 'PRs Created', data: creation.values, borderColor: 'blue', fill: false }],
        'PR Creation per Week'
      );

      // PR Closed
      const closed = prepareLabelsAndData(metrics.pr_close_weekly);
      plotWeeklyChart(
        document.getElementById('prClosedChart').getContext('2d'),
        closed.labels,
        [{ label: 'PRs Closed', data: closed.values, borderColor: 'orange', fill: false }],
        'PR Closed per Week'
      );

      // Staleness P50, P99, P100
      const staleLabels = Object.keys(metrics.stale_weekly_metrics).sort();
      const p50 = staleLabels.map(w => metrics.stale_weekly_metrics[w].p50);
      const p99 = staleLabels.map(w => metrics.stale_weekly_metrics[w].p99);
      const p100 = staleLabels.map(w => metrics.stale_weekly_metrics[w].p100);

      plotWeeklyChart(
        document.getElementById('stalenessChart').getContext('2d'),
        staleLabels,
        [
          { label: 'P50', data: p50, borderColor: 'green', fill: false },
          { label: 'P99', data: p99, borderColor: 'red', fill: false },
          { label: 'P100', data: p100, borderColor: 'black', fill: false }
        ],
        'PR Staleness (hours) per Week'
      );

      // Response time P50, P99, P100
      const respLabels = Object.keys(metrics.response_weekly_metrics).sort();
      const r50 = respLabels.map(w => metrics.response_weekly_metrics[w].p50);
      const r99 = respLabels.map(w => metrics.response_weekly_metrics[w].p99);
      const r100 = respLabels.map(w => metrics.response_weekly_metrics[w].p100);

      plotWeeklyChart(
        document.getElementById('responseChart').getContext('2d'),
        respLabels,
        [
          { label: 'P50', data: r50, borderColor: 'green', fill: false },
          { label: 'P99', data: r99, borderColor: 'red', fill: false },
          { label: 'P100', data: r100, borderColor: 'black', fill: false }
        ],
        'PR Response Time (hours) per Week'
      );

      // Top Stale PRs
      populateTopStaleTable(metrics.top_stale_prs);
    })();
  </script>
</body>

</html>
